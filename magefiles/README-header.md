[![Go Report Card](https://goreportcard.com/badge/github.com/rlnas/xk6-mock-server)](https://goreportcard.com/report/github.com/rlnas/xk6-mock-server)
[![GitHub Actions](https://github.com/rlnas/xk6-mock-server/workflows/Test/badge.svg)](https://github.com/rlnas/xk6-mock-server/actions?query=workflow%3ATest+branch%3Amaster)
[![codecov](https://codecov.io/gh/szkiba/xk6-mock/branch/master/graph/badge.svg?token=GK1JNCPH8U)](https://codecov.io/gh/szkiba/xk6-mock)
[![Documentation](https://img.shields.io/badge/docs-reference-blue?logo=readme&logoColor=lightgray)](https://ivan.szkiba.hu/xk6-mock)


# xk6-mock

A [k6](https://go.k6.io/k6) extension enables mocking HTTP(S) servers during test development.

The design of the library was inspired by [Express.js](https://expressjs.com/). If you have already known Express.js framework, using this library should be very simple.

```JavaScript
import http, { mock } from 'k6/x/mock'

mock('https://example.com', app => {
  app.get('/', (req, res) => {
    res.json({ greeting: 'Hello World!' })
  })
})

export default async function () {
  const res = await http.asyncRequest('GET', 'https://example.com')
  console.log(res.json())
}
```

## Features

- Starts mock HTTP server(s) inside the k6 process
- Familiar, Express like mock route definitions
- Almost transparent for test scripts: just change import statement from `k6/http` to `k6/x/mock`
- Helps testing k6 tests with mock server
- Supports sync and async `k6/http` API

> **Note**
> The implementation of a micro web framework (similar to Express.js) was moved to [muxpress](https://github.com/szkiba/muxpress) project. (Just in case you're interested in goja)

## Download

You can download pre-built k6 binaries from [Releases](https://github.com/rlnas/xk6-mock-server/releases/) page. Check [Packages](https://github.com/rlnas/xk6-mock-server/pkgs/container/xk6-mock) page for pre-built k6 Docker images.

## Build

You can build the k6 binary on various platforms, each with its requirements. The following shows how to build k6 binary with this extension on GNU/Linux distributions.

### Prerequisites

You must have the latest Go version installed to build the k6 binary. The latest version should match [k6](https://github.com/grafana/k6#build-from-source) and [xk6](https://github.com/grafana/xk6#requirements).

- [Git](https://git-scm.com/) for cloning the project
- [xk6](https://github.com/grafana/xk6) for building k6 binary with extensions

### Install and build the latest tagged version

1. Install `xk6`:

   ```shell
   go install go.k6.io/xk6/cmd/xk6@latest
   ```

2. Build the binary:

   ```shell
   xk6 build --with github.com/rlnas/xk6-mock-server@latest
   ```

> **Note**
> You can always use the latest version of k6 to build the extension, but the earliest version of k6 that supports extensions via xk6 is v0.43.0. The xk6 is constantly evolving, so some APIs may not be backward compatible.

### Build for development

If you want to add a feature or make a fix, clone the project and build it using the following commands. The xk6 will force the build to use the local clone instead of fetching the latest version from the repository. This process enables you to update the code and test it locally.

```bash
git clone git@github.com:szkiba/xk6-mock.git && cd xk6-mock
xk6 build --with github.com/rlnas/xk6-mock-server@latest=.
```

## Docker

You can also use pre-built k6 image within a Docker container. In order to do that, you will need to execute something like the following:

**Linux**

```plain
docker run -v $(pwd):/scripts -it --rm ghcr.io/szkiba/xk6-mock:latest run --out=dashboard /scripts/script.js
```

**Windows**

```plain
docker run -v %cd%:/scripts -it --rm ghcr.io/szkiba/xk6-mock:latest run --out=dashboard /scripts/script.js
```

## Example scripts

There are many examples in the [scripts](https://github.com/rlnas/xk6-mock-server/tree/master/scripts) directory that show how to use various features of the extension.

# API

<!-- Code generated by typedoc. DO NOT EDIT -->
